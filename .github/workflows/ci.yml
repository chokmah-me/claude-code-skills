name: Claude Code Skills CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  validate:
    name: Validate Skills
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt 2>/dev/null || true
        pip install pytest pytest-cov flake8 black mypy
        
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: Format check with black
      run: |
        black --check --diff .
        
    - name: Type check with mypy
      run: |
        mypy . --ignore-missing-imports || true
        
    - name: Validate skill structure
      run: |
        python tests/validate_skills.py --verbose
        
    - name: Test installation process
      run: |
        # Test dry run installation
        python install.py --all --dry-run
        
        # Test actual installation (limited skills for speed)
        python install.py --skills session-snapshot skill-extractor
        
    - name: Verify skill functionality
      run: |
        python tests/test_skills.py --verbose
        
    - name: Test skill documentation
      run: |
        python tests/check_documentation.py --verbose
        
    - name: Generate skill report
      run: |
        python tests/generate_report.py --output reports/skill-report-${{ matrix.os }}-py${{ matrix.python-version }}.json
        
    - name: Upload skill report
      uses: actions/upload-artifact@v3
      with:
        name: skill-reports-${{ matrix.os }}-py${{ matrix.python-version }}
        path: reports/

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        
    - name: Run Bandit security scan
      run: |
        bandit -r . -f json -o reports/bandit-report.json || true
        
    - name: Check for known vulnerabilities
      run: |
        safety check --json --output reports/safety-report.json || true
        
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: reports/

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install documentation tools
      run: |
        python -m pip install --upgrade pip
        pip install markdown-link-check markdownlint-cli
        
    - name: Check markdown links
      run: |
        find . -name "*.md" -exec markdown-link-check {} \; || true
        
    - name: Lint markdown files
      run: |
        markdownlint *.md docs/*.md skills/**/*.md || true
        
    - name: Generate documentation report
      run: |
        python tests/check_documentation.py --generate-report --output reports/docs-report.json
        
    - name: Upload documentation reports
      uses: actions/upload-artifact@v3
      with:
        name: documentation-reports
        path: reports/

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Claude Code CLI (simulated)
      run: |
        # Create a mock Claude Code environment for testing
        mkdir -p ~/.claude/skills
        echo "Mock Claude Code environment created"
        
    - name: Test full installation
      run: |
        # Test complete installation process
        python install.py --all
        
        # Verify all skills are installed
        python install.py --verify
        
    - name: Test category installation
      run: |
        # Clean previous installation
        rm -rf ~/.claude/skills/*
        
        # Test category-based installation
        python install.py --category meta
        python install.py --category development
        
        # Verify category installation
        python install.py --verify
        
    - name: Test individual skill installation
      run: |
        # Clean previous installation
        rm -rf ~/.claude/skills/*
        
        # Test specific skill installation
        python install.py --skills session-snapshot skill-extractor repo-analyzer
        
        # Verify specific skills
        python install.py --verify
        
    - name: Test uninstallation
      run: |
        # Test uninstall process
        python install.py --uninstall session-snapshot
        
        # Verify uninstallation
        python install.py --verify

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install performance tools
      run: |
        python -m pip install --upgrade pip
        pip install memory_profiler line_profiler
        
    - name: Run performance tests
      run: |
        python tests/performance_tests.py --output reports/performance-report.json
        
    - name: Benchmark installation speed
      run: |
        time python install.py --all --dry-run
        
    - name: Upload performance reports
      uses: actions/upload-artifact@v3
      with:
        name: performance-reports
        path: reports/

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [validate, security, documentation, integration]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Generate release notes
      run: |
        python scripts/generate_release_notes.py --output RELEASE_NOTES.md
        
    - name: Create skill bundle
      run: |
        python scripts/create_bundle.py --output claude-code-skills-bundle.zip
        
    - name: Upload release artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-artifacts
        path: |
          RELEASE_NOTES.md
          claude-code-skills-bundle.zip
          
    - name: Update skill statistics
      run: |
        python scripts/update_statistics.py --output docs/statistics.md
        
    - name: Commit statistics update
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/statistics.md
        git diff --quiet && git diff --staged --quiet || git commit -m "Update skill statistics [skip ci]"
        git push

  notify:
    name: Notify Community
    runs-on: ubuntu-latest
    needs: [publish]
    if: always()
    
    steps:
    - name: Notify Discord
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      with:
        args: |
          ðŸš€ Claude Code Skills CI/CD completed!
          Status: ${{ needs.publish.result }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          
    - name: Update repository stats
      uses: jgehrcke/github-repo-stats@master
      with:
        ghtoken: ${{ secrets.GITHUB_TOKEN }}