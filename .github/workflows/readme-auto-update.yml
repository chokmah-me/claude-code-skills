name: README Auto-Update

on:
  push:
    branches:
      - main
    paths:
      - 'skills/**'
      - '.claude/skills/**'
      - 'README.md'
  workflow_dispatch:
  schedule:
    # Run weekly to keep README updated
    - cron: '0 12 * * 1'

env:
  PYTHON_VERSION: '3.11'

jobs:
  update-readme:
    name: Update README with Skill Inventory
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip import json
import re
from pathlib import Path
from datetime import datetime

class ReadmeUpdater:
    def __init__(self):
        self.skills_inventory = {}
        self.stats = {
            'total_skills': 0,
            'categories': 0,
            'skills_with_readme': 0
        }
    
    def scan_skills(self):
        '''Scan for skills in the repository'''
        skill_locations = [
            ('skills', 'skills'),
            ('.claude/skills', '.claude/skills')
        ]
        
        for base_path, display_name in skill_locations:
            skills_dir = Path(base_path)
            if skills_dir.exists():
                print(f'üìÅ Scanning {display_name} directory...')
                
                for category_dir in skills_dir.iterdir():
                    if category_dir.is_dir() and not category_dir.name.startswith('.'):
                        category = category_dir.name
                        if category not in self.skills_inventory:
                            self.skills_inventory[category] = []
                        
                        print(f'  üìÇ Found category: {category}')
                        
                        for skill_dir in category_dir.iterdir():
                            if skill_dir.is_dir() and not skill_dir.name.startswith('.'):
                                skill_name = skill_dir.name
                                skill_info = self.analyze_skill(skill_dir, category, skill_name)
                                self.skills_inventory[category].append(skill_info)
                                self.stats['total_skills'] += 1
                                
                                if skill_info['has_readme']:
                                    self.stats['skills_with_readme'] += 1
        
        self.stats['categories'] = len(self.skills_inventory)
        print(f'üìä Found {self.stats["total_skills"]} skills across {self.stats["categories"]} categories')
    
    def analyze_skill(self, skill_path, category, skill_name):
        '''Analyze a single skill'''
        skill_file = skill_path / 'SKILL.md'
        readme_file = skill_path / 'README.md'
        
        info = {
            'name': skill_name,
            'category': category,
            'has_readme': readme_file.exists(),
            'has_skill_md': skill_file.exists(),
            'description': '',
            'purpose': ''
        }
        
        # Extract description from SKILL.md
        if skill_file.exists():
            try:
                with open(skill_file, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # Look for purpose or description
                purpose_match = re.search(r'Purpose:(.*?)(?:\n|$)', content, re.IGNORECASE)
                if purpose_match:
                    info['purpose'] = purpose_match.group(1).strip()
                
                # Look for first sentence as description
                lines = content.split('\n')
                for line in lines:
                    line = line.strip()
                    if line and not line.startswith('#') and not line.startswith('---'):
                        info['description'] = line[:100] + '...' if len(line) > 100 else line
                        break
                        
            except Exception as e:
                print(f'‚ö†Ô∏è  Error reading {skill_file}: {e}')
        
        return info
    
    def generate_skills_section(self):
        '''Generate the skills inventory section for README'''
        lines = []
        lines.append('## üõ†Ô∏è Available Skills\n')
        lines.append(f'*Last updated: {datetime.now().strftime("%Y-%m-%d %H:%M UTC")}*\n')
        
        # Add statistics
        lines.append('### üìä Skills Statistics\n')
        lines.append(f'- **Total Skills**: {self.stats["total_skills"]}')
        lines.append(f'- **Categories**: {self.stats["categories"]}')
        lines.append(f'- **Skills with README**: {self.stats["skills_with_readme"]}')
        lines.append('')
        
        # Add skills by category
        for category, skills in sorted(self.skills_inventory.items()):
            if not skills:
                continue
                
            lines.append(f'### {category.title()}\n')
            
            for skill in sorted(skills, key=lambda x: x['name']):
                skill_line = f'- **{skill["name"].replace("-", " ").title()}**'
                
                if skill['has_readme']:
                    # Link to README if it exists
                    skill_path = f'skills/{category}/{skill["name"]}'
                    if Path(f'.claude/skills/{category}/{skill["name"]}').exists():
                        skill_path = f'.claude/skills/{category}/{skill["name"]}'
                    
                    skill_line += f' [`README`]({skill_path}/README.md)'
                
                if skill['purpose']:
                    skill_line += f' - {skill["purpose"]}'
                elif skill['description']:
                    skill_line += f' - {skill["description"]}'
                
                lines.append(skill_line)
            
            lines.append('')
        
        return '\n'.join(lines)
    
    def update_readme(self):
        '''Update the README.md file'''
        readme_path = Path('README.md')
        
        if not readme_path.exists():
            print('‚ùå README.md not found')
            return False
        
        try:
            with open(readme_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # Find the skills section markers
            start_marker = '<!-- SKILLS_INVENTORY_START -->'
            end_marker = '<!-- SKILLS_INVENTORY_END -->'
            
            if start_marker not in content or end_marker not in content:
                print('‚ö†Ô∏è  Skills section markers not found in README.md')
                print('  Add <!-- SKILLS_INVENTORY_START --> and <!-- SKILLS_INVENTORY_END --> to your README')
                return False
            
            # Generate new skills section
            skills_section = self.generate_skills_section()
            
            # Replace the section
            pattern = f'{re.escape(start_marker)}.*?{re.escape(end_marker)}'
            replacement = f'{start_marker}\n{skills_section}\n{end_marker}'
            
            new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
            
            if new_content == content:
                print('‚ÑπÔ∏è  No changes needed in README.md')
                return True
            
            # Write updated content
            with open(readme_path, 'w', encoding='utf-8') as f:
                f.write(new_content)
            
            print('‚úÖ README.md updated successfully')
            return True
            
        except Exception as e:
            print(f'‚ùå Error updating README.md: {e}')
            return False

def main():
    updater = ReadmeUpdater()
    
    # Scan for skills
    updater.scan_skills()
    
    # Update README
    if updater.update_readme():
        print('\\nüìã Skills inventory updated in README.md')
        print(f'üìä Total skills: {updater.stats["total_skills"]}')
        print(f'üìÅ Categories: {updater.stats["categories"]}')
        return True
    else:
        print('\\n‚ùå Failed to update README.md')
        return False

if __name__ == '__main__':
    import sys
    success = main()
    sys.exit(0 if success else 1)
          "

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "No changes needed"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ü§ñ Auto-update skills inventory in README

          - Updated skills inventory
          - Added statistics and categorization
          - Auto-generated by GitHub Actions"
          
          # Push changes
          git push

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true' && github.event_name == 'workflow_dispatch'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ü§ñ Auto-update skills inventory in README"
          title: "ü§ñ Auto-update skills inventory in README"
          body: |
            ## üìã Skills Inventory Update
            
            This PR automatically updates the skills inventory section in README.md with the latest information about available skills.
            
            ### Changes:
            - Updated skills list and categorization
            - Added statistics about total skills and categories
            - Generated on: ${{ github.event.head_commit.timestamp || github.event.schedule }}
            
            ### Auto-generated by:
            - GitHub Actions workflow: `${{ github.workflow }}`
            - Run ID: `${{ github.run_id }}`
            
            ---
            *This PR was automatically generated by the README Auto-Update workflow.*
          branch: auto-update-readme-skills
          delete-branch: true

      - name: Upload skills inventory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: skills-inventory
          path: |
            skills-inventory.json
            README.md
          retention-days: 30