name: Post-Tag Maintenance

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.2.3
  workflow_dispatch:  # Allow manual triggering
    inputs:
      tag:
        description: 'Tag to process (leave empty for latest)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  post-tag-updates:
    name: Update Documentation and Metadata
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper git operations
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get tag information
        id: tag_info
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "year=$(date -u +%Y)" >> $GITHUB_OUTPUT

      - name: Update README.md version and date references
        run: |
          # Update "Last updated" references
          sed -i "s/Last updated: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/Last updated: ${{ steps.tag_info.outputs.date }}/g" README.md

          # Update version references if they exist
          sed -i "s/Version: v[0-9]\+\.[0-9]\+\.[0-9]\+/Version: ${{ steps.tag_info.outputs.tag }}/g" README.md

          echo "[OK] Updated README.md with new date and version"

      - name: Update CLAUDE.md metadata
        run: |
          if [ -f "CLAUDE.md" ]; then
            sed -i "s/Last updated: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/Last updated: ${{ steps.tag_info.outputs.date }}/g" CLAUDE.md
            echo "[OK] Updated CLAUDE.md"
          fi

      - name: Update CONTRIBUTING.md dates
        run: |
          if [ -f "CONTRIBUTING.md" ]; then
            sed -i "s/Last updated: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/Last updated: ${{ steps.tag_info.outputs.date }}/g" CONTRIBUTING.md
            echo "[OK] Updated CONTRIBUTING.md"
          fi

      - name: Generate/Update CHANGELOG.md
        run: |
          python3 << 'EOF'
          import re
          import subprocess
          from datetime import datetime

          tag = "${{ steps.tag_info.outputs.tag }}"
          date = "${{ steps.tag_info.outputs.date }}"

          # Get commits since last tag
          try:
              prev_tag = subprocess.check_output(
                  ["git", "describe", "--tags", "--abbrev=0", f"{tag}^"],
                  text=True
              ).strip()
              log_range = f"{prev_tag}..{tag}"
          except:
              # First tag
              log_range = tag

          # Get commit messages
          commits = subprocess.check_output(
              ["git", "log", log_range, "--pretty=format:- %s (%h)"],
              text=True
          ).strip()

          # Create changelog entry
          new_entry = f"""
## [{tag}] - {date}

### Changes

{commits}

"""

          # Read existing changelog or create new
          try:
              with open("CHANGELOG.md", "r") as f:
                  existing = f.read()
          except FileNotFoundError:
              existing = "# Changelog\n\nAll notable changes to this project will be documented in this file.\n"

          # Insert new entry after header
          if "# Changelog" in existing:
              parts = existing.split("\n", 3)
              updated = parts[0] + "\n" + parts[1] + "\n" + parts[2] + "\n" + new_entry + "\n" + (parts[3] if len(parts) > 3 else "")
          else:
              updated = "# Changelog\n\n" + new_entry + "\n" + existing

          with open("CHANGELOG.md", "w") as f:
              f.write(updated)

          print("[OK] Updated CHANGELOG.md")
          EOF

      - name: Generate/Update sitemap.xml
        run: |
          python3 << 'EOF'
          from pathlib import Path
          from datetime import datetime

          date = "${{ steps.tag_info.outputs.date }}"

          # Find all markdown files
          md_files = list(Path(".").rglob("*.md"))

          # Start sitemap
          sitemap = ['<?xml version="1.0" encoding="UTF-8"?>']
          sitemap.append('<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">')

          # Add main pages
          sitemap.append('  <url>')
          sitemap.append('    <loc>https://github.com/chokmah-me/claude-code-skills</loc>')
          sitemap.append(f'    <lastmod>{date}</lastmod>')
          sitemap.append('    <priority>1.0</priority>')
          sitemap.append('  </url>')

          # Add skill pages
          for md_file in sorted(md_files):
              if '.github' in str(md_file) or 'node_modules' in str(md_file):
                  continue

              if 'skills/' in str(md_file):
                  # Create GitHub URL
                  path = str(md_file).replace('\\', '/')
                  url = f'https://github.com/chokmah-me/claude-code-skills/blob/main/{path}'

                  sitemap.append('  <url>')
                  sitemap.append(f'    <loc>{url}</loc>')
                  sitemap.append(f'    <lastmod>{date}</lastmod>')
                  sitemap.append('    <priority>0.8</priority>')
                  sitemap.append('  </url>')

          sitemap.append('</urlset>')

          with open('sitemap.xml', 'w') as f:
              f.write('\n'.join(sitemap))

          print("[OK] Generated sitemap.xml")
          EOF

      - name: Update skill metadata with release info
        run: |
          python3 << 'EOF'
          from pathlib import Path
          import re

          tag = "${{ steps.tag_info.outputs.tag }}"
          date = "${{ steps.tag_info.outputs.date }}"

          # Find all SKILL.md files
          skill_files = list(Path("skills").rglob("SKILL.md"))

          for skill_file in skill_files:
              content = skill_file.read_text(encoding='utf-8')

              # Update or add version metadata in frontmatter
              if content.startswith('---'):
                  # Has frontmatter
                  end_idx = content.find('---', 3)
                  if end_idx > 0:
                      frontmatter = content[3:end_idx]
                      body = content[end_idx+3:]

                      # Update or add last_updated
                      if 'last_updated:' in frontmatter:
                          frontmatter = re.sub(
                              r'last_updated:.*',
                              f'last_updated: {date}',
                              frontmatter
                          )
                      else:
                          frontmatter += f'\nlast_updated: {date}'

                      # Update or add version
                      if 'version:' in frontmatter:
                          frontmatter = re.sub(
                              r'version:.*',
                              f'version: {tag}',
                              frontmatter
                          )
                      else:
                          frontmatter += f'\nversion: {tag}'

                      updated_content = f'---{frontmatter}---{body}'
                      skill_file.write_text(updated_content, encoding='utf-8')

          print(f"[OK] Updated {len(skill_files)} skill files with version metadata")
          EOF

      - name: Create maintenance snapshot
        run: |
          cat > .maintenance-snapshot.md << 'EOF'
          # Post-Tag Maintenance Snapshot

          **Tag**: ${{ steps.tag_info.outputs.tag }}
          **Date**: ${{ steps.tag_info.outputs.timestamp }}
          **Triggered by**: ${{ github.event_name }}

          ## Updates Applied

          - [OK] Updated README.md with new date references
          - [OK] Updated CLAUDE.md metadata
          - [OK] Updated CONTRIBUTING.md dates
          - [OK] Generated/Updated CHANGELOG.md with commit history
          - [OK] Generated sitemap.xml with all documentation pages
          - [OK] Updated skill metadata in all SKILL.md files

          ## Files Modified

          - README.md
          - CLAUDE.md
          - CONTRIBUTING.md
          - CHANGELOG.md
          - sitemap.xml
          - skills/**/SKILL.md (metadata updates)

          ## Next Steps

          - Verify all changes are correct
          - Commit and push to main branch
          - Monitor for any issues

          ---
          *Generated by post-tag-maintenance workflow*
          EOF

          echo "[OK] Created maintenance snapshot"

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add README.md CLAUDE.md CONTRIBUTING.md CHANGELOG.md sitemap.xml skills/ .maintenance-snapshot.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m " Post-tag maintenance for ${{ steps.tag_info.outputs.tag }}

          - Updated date references in documentation
          - Generated CHANGELOG entry
          - Updated sitemap.xml
          - Updated skill metadata

          Automated by post-tag-maintenance workflow"

            git push origin HEAD:main
            echo "[OK] Changes committed and pushed"
          fi

      - name: Create maintenance summary
        run: |
          echo "## [SUCCESS] Post-Tag Maintenance Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ steps.tag_info.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: ${{ steps.tag_info.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updates Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [OK] Documentation date references" >> $GITHUB_STEP_SUMMARY
          echo "- [OK] CHANGELOG.md generation" >> $GITHUB_STEP_SUMMARY
          echo "- [OK] sitemap.xml generation" >> $GITHUB_STEP_SUMMARY
          echo "- [OK] Skill metadata updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All changes have been committed to the main branch." >> $GITHUB_STEP_SUMMARY
